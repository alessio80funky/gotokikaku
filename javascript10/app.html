<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>出勤管理アプリ</title>
</head>
<body>

    <h1>勤怠アプリ</h1>
    <p>本日の日付：<span id="today"> </span></p>
    <button id="start">出勤</button>
    <button id="end">退勤</button>

    <table>
        <thead>
            <tr>
                <th>日付</th>
                <th>出勤時刻</th>
                <th>退勤時刻</th>
                <th>勤務時間合計</th>
                <th>時間</th><!--追加-->
                <th>分</th> <!--追加-->
            </tr>
        </thead>
        <tbody id="tableData"></tbody>
    </table>

    <div id="chartContainer">
        <canvas id="Chart1"></canvas><!--追加-->
        <canvas id="Chart2"></canvas><!--追加-->
    </div>

    <script>
        //日付の処理・JSとHTMLのIDの連携の処理

        //JSとHTMLのIDの連携の処理(button以外のId)
        const todayDate = document.getElementById("today");
        const tableData =  document.getElementById("tableData");

         //日付の処理

         const now = new Date();
         todayDate.textContent = now.toLocaleDateString("ja-JP", {
            year:"numeric", 
            month:"long", 
            day:"numeric", 
            weekday:"long", 
            hour:"2-digit",minute:"2-digit"
         });

         //localStorageの連携(データ収得)

         let records = JSON.parse(localStorage.getItem("records")  || "[]");

            //出勤ボタン
            document.getElementById("start").addEventListener("click", () =>{

                const date = new Date;

                const today = date.toLocaleDateString("ja-JP");
                const time = date.toLocaleTimeString("ja-JP");

                //データの重複を防ぐ
                const exist = records.find(r => r.date === today);
                if(exist){
                    alert("本日はすでに出勤が登録されています。")
                    return;
                }

                records.push({date: today, start: time, end:null, hour:0})
                update();
            })

            //退勤ボタン

            document.getElementById("end").addEventListener("click", () =>{
            const date = new Date;

            const today = date.toLocaleDateString("ja-JP");
            const time = date.toLocaleTimeString("ja-JP");


            const recordData = records.find(r => r.date === today);
            if(!recordData){
                alert("出勤データありません。先に打刻して下さい。")
                return;
            }

            recordData.end = time;

            //合計の計算のロジック
            const startTime = new Date(`${recordData.date} ${recordData.start}`);
            const endTime = new Date(`${recordData.date} ${recordData.end}`);

            const hour = ((endTime - startTime) / (1000 * 60 * 60)).toFixed(2);
            recordData.hour = parseFloat(Number(hour));//修正

            const difference = endTime - startTime;
            const totalMins = difference / (1000 * 60);//修正
            const hours = totalMins / 60;
            const minutes = totalMins % 60;
            recordData.h= parseFloat(Number(hours).toFixed(0));//修正
            recordData.m= parseFloat(Number(minutes).toFixed(0));//修正

            update();
    })

    //データのアップデートのロジック

   //保存
    function update(){
        localStorage.setItem("records", JSON.stringify(records));
        tableWiew();
        hourChart();//名前変更
        minsChart();//名前変更・追加
    }

      //テーブルにデータ表示する

    function tableWiew(){
        tableData.innerHTML="";

        records.forEach(r => {


            const tr = document.createElement("tr");

            tr.innerHTML=`
        <td>${r.date}</td>
        <td>${r.start || "-"}</td>
        <td>${r.end || "-"}</td>
        <td>${r.hour}</td>
        <td>${r.h}</td>
        <td>${r.m}</td>
        `; 

        tableData.appendChild(tr);
        })
    }

    let hourChartProp;//名前変更・追加

    function hourChart(){//名前変更
        const ctx = document.getElementById("Chart1").getContext("2d");

        if(hourChartProp) hourChartProp.destroy();//名前変更

        hourChartProp = new Chart(ctx, {//名前変更
            type:"bar",
            data: {
                labels: records.map(r => r.date),
                datasets:[{
                    label: "時間",
                    data: records.map(r => r.h),
                    borderWidth:1
                }],
            },
            options: {
                responsive: true,
                scales: {
                    y:{
                        beginAtZero: true
                    }
                }
            }
        })
    }


    let minsChartProp;//追加

    //関数全体追加
    function minsChart(){
        const ctx = document.getElementById("Chart2").getContext("2d");

        if(minsChartProp) minsChartProp.destroy();

        minsChartProp = new Chart(ctx, {
            type:"bar",
            data: {
                labels: records.map(r => r.date),
                datasets:[{
                    label: "分",
                    data: records.map(r => r.m),
                    borderWidth:1
                }],
            },
            options: {
                responsive: true,
                scales: {
                    y:{
                        beginAtZero: true
                    }
                }
            }
        })
    }

    minsChart();//追加
    hourChart();//追加
    tableWiew();
    </script>
</body>
</html>